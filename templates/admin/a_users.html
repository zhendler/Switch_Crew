{% extends "admin_base.html" %}

{% block content %}
<link rel="stylesheet" href="/static/css/admin_users.css">
<div class="admin-container">
    <div class="user-list">
        <h2>Users</h2>
        <ul id="user-list"></ul>
    </div>
    <div class="user-details">
        <h2>User Details</h2>
        <div id="user-info">
            <p>Select a user to see details</p>
        </div>
    </div>
        <div class="user-comments">
        <h2>User Details</h2>
        <div id="user-comments">
            <p>Select a user to see details</p>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const userList = document.getElementById("user-list");
        const userInfo = document.getElementById("user-info");
        const userComments = document.getElementById("user-comments");

        function fetchUsers() {
            fetch("/admin/users")
                .then(response => response.json())
                .then(users => {
                    userList.innerHTML = "";
                    users.forEach(user => {
                        const li = document.createElement("li");
                        li.textContent = user.username;
                        li.dataset.userId = user.id;
                        li.addEventListener("click", () => fetchUserDetails(user.id));
                        userList.appendChild(li);
                    });
                })
                .catch(error => console.error("Error fetching users:", error));
        }

        function fetchUserDetails(userId) {
            fetch(`/admin/${userId}`)
                .then(response => response.json())
                .then(user => {
                    userInfo.innerHTML = `
                        <div class = "user-info">

                            <img src="${user.avatar_url}" alt="${user.username}'s avatar" style="width: 100px; height: 100px; border-radius: 50%;">
                        </div>
                        <h3 style = "text-align: center">${user.username}</h3>
                        <p>Full name: ${user.first_name} ${user.last_name}</p>
                        <p>Birth date: ${user.birth_date}</p>
                        <p>Email: ${user.email}</p>
                        <p>Country: ${user.country}</p>
                        <p>Role: ${user.role_id}</p>
                        <p>Joined on: ${user.created_at}</p>
                        <p>Photo count: ${user.photos_count}</p>
                        <p>Comments count: ${user.comments_count}</p>
                    `;
                })
                .catch(error => console.error("Error fetching user details:", error));
        }

        function fetchUserComments(userId) {
            fetch(`/admin/comments/${userId}`)
                .then(response => response.json())
                .then(comments => {
                    userComments.innerHTML = "<h3>Latest Comments</h3>";

                    if (comments.length === 0) {
                        userComments.innerHTML += "<p>No comments found.</p>";
                        return;
                    }

                    const commentList = document.createElement("div");
                    commentList.classList.add("comment-list");

                    comments.forEach(comment => {
                        const commentCard = document.createElement("div");
                        commentCard.classList.add("comment-card");
                        commentCard.innerHTML = `
                            <p class="comment-time">${new Date(comment.created_at).toLocaleString()}</p>
                            <p class="comment-text">${comment.content}</p>
                            <a href="/photo/${comment.photo_id}" target="_blank" class="comment-photo-link">
                                <img src="${comment.photo_thumbnail}" alt="Photo" class="comment-photo">
                            </a>
                        `;

                        commentCard.addEventListener("click", () => {
                            window.open(`/photo/${comment.photo_id}`, "_blank");
                        });

                        commentList.appendChild(commentCard);
                    });

                    userComments.appendChild(commentList);
                })
                .catch(error => console.error("Error fetching user comments:", error));
        }


        fetchUsers();
    });
</script>
{% endblock %}
