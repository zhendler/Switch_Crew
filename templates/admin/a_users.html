{% extends "admin_base.html" %}

{% block content %}
<link rel="stylesheet" href="/static/css/admin_users.css">
<link rel="stylesheet" href="/static/css/admin_comments_container.css">

<div class="admin-container">
    <div class="user-list">
        <h2>Users</h2>
        <ul id="user-list"></ul>
    </div>
    <div class="user-details">
        <h2>User Details</h2>
        <div id="user-info">
            <p>Select a user to see details</p>
        </div>
    </div>
        <div class="user-comments">
        <h2>Resent comments</h2>
        <div id="user-comments">
            <p>Select a user to see details</p>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const userList = document.getElementById("user-list");
        const userInfo = document.getElementById("user-info");
        const userComments = document.getElementById("user-comments");

        function fetchUsers() {
            fetch("/admin/users")
                .then(response => response.json())
                .then(users => {
                    userList.innerHTML = "";
                    users.forEach(user => {
                        const li = document.createElement("li");
                        li.textContent = user.username;
                        li.dataset.userId = user.id;
                        li.addEventListener("click", () => {
                            fetchUserDetails(user.id);
                            fetchUserComments(user.id);
                        });
                        userList.appendChild(li);
                    });
                })
                .catch(error => console.error("Error fetching users:", error));
        }

        function fetchUserDetails(userId) {
            fetch(`/admin/${userId}`)
                .then(response => response.json())
                .then(user => {
                    let roleText = "User";
                    if (user.role_id === 1) roleText = "Admin";
                    else if (user.role_id === 2) roleText = "Moderator";

                    let banText = user.is_banned ? "Unban" : "Ban";
                    let banClass = user.is_banned ? "unban-btn" : "ban-btn";

                    userInfo.innerHTML = `
                        <div class="user-info">
                            <img src="${user.avatar_url}" alt="${user.username}'s avatar"
                                 style="width: 100px; height: 100px; border-radius: 50%;">
                        </div>
                        <h3 style="text-align: center">${user.username} , ID: ${user.id}</h3>
                        <p>Full name: ${user.first_name} ${user.last_name}</p>
                        <p>Birth date: ${user.birth_date}</p>
                        <p>Email: ${user.email}</p>
                        <p>Country: ${user.country}</p>
                        <p>Role:
                            <select id="role-select">
                                <option value="1" ${user.role_id === 1 ? "selected" : ""}>Admin</option>
                                <option value="2" ${user.role_id === 2 ? "selected" : ""}>Moderator</option>
                                <option value="3" ${user.role_id === 3 ? "selected" : ""}>User</option>
                            </select>
                            <button id="change-role-btn">Change</button>
                        </p>
                        <p>Joined on: ${user.created_at}</p>
                        <p>Photo count: ${user.photos_count}</p>
                        <p>Comments count: ${user.comments_count}</p>
                        <button id="ban-btn" class="${banClass}">${banText}</button>
                        <button id="edit-profile-btn">Edit Profile</button>
                    `;

                    document.getElementById("ban-btn").addEventListener("click", function() {
                        toggleBan(userId, this);
                    });
                    document.getElementById("change-role-btn").addEventListener("click", () => changeUserRole(userId));
                    document.getElementById("edit-profile-btn").addEventListener("click", () => editUserProfile(userId));
                })
                .catch(error => console.error("Error fetching user details:", error));
        }

        function toggleBan(userId, buttonElement) {
            if (!userId) {
                console.error("User ID is missing!");
                alert("User ID is missing!");
                return;
            }

            fetch(`/admin/ban_unban_user/${userId}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .then(response => {
                return response.json().then(data => {
                    if (!response.ok) {
                        throw new Error(data.message || "Failed to change ban status");
                    }
                    return data;
                });
            })
            .then(data => {
                alert(data.message); // Відображаємо відповідь сервера
                // Оновлюємо кнопку після успішного запиту
                if (data.is_banned !== undefined) {  // Перевіряємо, чи бекенд повернув is_banned
                    if (data.is_banned) {
                        buttonElement.textContent = "Unban";
                        buttonElement.classList.add("btn-danger");
                        buttonElement.classList.remove("btn-success");
                    } else {
                        buttonElement.textContent = "Ban";
                        buttonElement.classList.add("btn-success");
                        buttonElement.classList.remove("btn-danger");
                    }
                }
            })
            .catch(error => {
                console.error("Error changing ban status:", error);
                alert(error.message || "Failed to update ban status");
            });
        }



        function changeUserRole(userId) {
            const roleSelect = document.getElementById("role-select");
            const newRole = roleSelect.options[roleSelect.selectedIndex].text; // Отримуємо назву ролі

            fetch(`/admin/change_role/${userId}/?role=${encodeURIComponent(newRole)}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .then(response => {
                return response.json().then(data => {
                    if (!response.ok) {
                        throw new Error(data.message || "Failed to change role");
                    }
                    return data;
                });
            })
            .then(data => {
                alert(data.message); // Відображаємо відповідь сервера
            })
            .catch(error => {
                console.error("Error changing role:", error);
                alert(error.message || "Failed to update role");
            });
        }





        function editUserProfile(userId) {
            alert("Тут буде модальне вікно для редагування профілю!");
        }

        function fetchUserComments(userId) {
            fetch(`/admin/users_comments/${userId}`)
                .then(response => response.json())
                .then(comments => {
                    console.log("Comments received:", comments);

                    userComments.innerHTML = "<h3>Latest Comments</h3>";

                    if (comments.length === 0) {
                        userComments.innerHTML += "<p>No comments found.</p>";
                        return;
                    }

                    comments.forEach(comment => {
                        const commentCard = document.createElement("div");
                        commentCard.classList.add("comment-card");

                        commentCard.innerHTML = `
                            <img src="${comment.photo.url_link}" class="comment-photo" alt="Photo #${comment.photo.id}">
                            <div class="comment-text-container">
                                <p class="comment-time">${new Date(comment.created_at).toLocaleString()}</p>
                                <p class="comment-text">${comment.content}</p>
                                <a href="/photos/${comment.photo_id}" target="_blank" class="comment-photo-link">
                                    View Photo
                                </a>
                            </div>
                        `;

                        userComments.appendChild(commentCard);
                    });
                })
                .catch(error => console.error("Error fetching user comments:", error));
        }

        fetchUsers();
    });

</script>
{% endblock %}
